#!/bin/sh

set -e

[ $# -ne 1 ] && exit 1

case $1 in
    -s) ;;
    -w) workstation=1 ;;
    *) exit 1 ;;
esac

pkgs="curl ssh git tar gzip"

[ -n "$workstation" ] && pkgs="$pkgs gpg"

for pkg in $pkgs; do
    [ -x "$(command -v "$pkg")" ] || missing_pkgs="$missing_pkgs $pkg"
done

if [ -n "$missing_pkgs" ]; then
    printf "Install missing packages:%s\n" "$missing_pkgs"
    exit 1
fi

cd "$HOME"

mkdir -m 700 .ssh
mkdir repos
mkdir .config

if [ -n "$workstation" ]; then
    curl -LO https://github.com/red-magic/dotfiles/raw/master/extra/archive.tar.gz.gpg
    gpg -do archive.tar.gz archive.tar.gz.gpg
    tar xzf archive.tar.gz
    gpg --import archive/gpg/*.*
    cp -f archive/ssh/id_ed25519 .ssh
    cp -f archive/ssh/id_ed25519.pub .ssh
    cp -f archive/ssh/id_ed25519.pub .ssh/authorized_keys
    touch .ssh/known_hosts
    chmod 600 .ssh/known_hosts
    rm -rf archive*

    curl -L https://github.com/red-magic/dotfiles/raw/master/extra/configs/.ssh/config -o .ssh/config
    chmod 400 .ssh/config
    eval "$(ssh-agent -s)" && ssh-add
    git clone ssh://git@github.com/red-magic/dotfiles repos/dotfiles
    git clone ssh://git@github.com/red-magic/bible repos/bible
    if uname -s | grep -q Linux; then
        git clone ssh://git@github.com/red-magic/tty-colorscheme repos/tty-colorscheme
        git clone ssh://git@github.com/red-magic/cs16-server repos/cs16-server
        git clone ssh://git@github.com/red-magic/arti-bin repos/arti-bin
        if [ -f /etc/arch-release ]; then
            aurpkgs="pacproxy-bin simple-and-soft-cursor snowflake-pt-client-bin tor-relay-scanner-bin ttf-go tty-colorscheme windows-10-cursor"
            mkdir repos/aur
            for aurpkg in $aurpkgs; do
                git clone "ssh://aur@aur.archlinux.org/$aurpkg" "repos/aur/$aurpkg"
            done
        fi
    fi

    mkdir .config/emacs
    cp -vf repos/dotfiles/extra/configs/.config/emacs/init.el .config/emacs
    cp -vf repos/dotfiles/extra/configs/.gitconfig .
fi

[ -z "$workstation" ] && git clone https://github.com/red-magic/dotfiles repos/dotfiles

mkdir .config/ranger
cp -vf repos/dotfiles/extra/configs/.config/ranger/rc.conf .config/ranger

if uname -s | grep -q Linux; then
    cp -vf repos/dotfiles/linux/configs/.bash_profile .
    ln -sf .bash_profile .bashrc
elif uname -s | grep -q BSD; then
    cp -vf repos/dotfiles/openbsd/configs/.profile .
    cp -vf repos/dotfiles/openbsd/configs/.mailrc .
    chmod 700 "$HOME"
    if [ -n "$workstation" ]; then
        cp -vf repos/dotfiles/extra/configs/xorg/.cwmrc .
        cp -vf repos/dotfiles/extra/configs/xorg/.xsession .
        cp -vf repos/dotfiles/extra/configs/xorg/.Xdefaults .
        echo >> .Xdefaults
        cat repos/dotfiles/extra/themes/xorg/.Xdefaults-mono-brown >> .Xdefaults
        mkdir .fonts
        cp -vrf repos/dotfiles/extra/configs/.fonts/Go .fonts
    fi
fi
