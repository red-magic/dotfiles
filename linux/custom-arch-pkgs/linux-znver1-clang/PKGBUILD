pkgname=linux-znver1-clang
pkgver=6.3.9
pkgrel=1
pkgdesc='Linux kernel for znver1 architecture'
arch=(x86_64)
license=(GPL2)
install=linux.install
conflicts=(linux-znver1)

source=(https://cdn.kernel.org/pub/linux/kernel/v${pkgver::1}.x/linux-$pkgver.tar.xz
	https://gitlab.archlinux.org/archlinux/packaging/packages/linux/-/raw/$pkgver.arch1-1/config
	linux.preset)

b2sums=(SKIP
	SKIP
	SKIP)

depends=(
	base-devel
	bc
	cpio
	#git # No need
	inetutils
	kmod
	libelf
	pahole
	perl
	#rsync # For headers
	tar
	#xmlto # For docs
	xz
	clang
	lld
	llvm
)

optdepends=(
	amd-ucode
	linux-firmware
)

_arch=znver1

_linuxsrc=linux-$pkgver

_kernelmake() {
	local flags="-O2 -pipe -march=$_arch -mtune=$_arch"
	make LLVM=1 LOCALVERSION=-"$_arch" KCFLAGS="$flags" KCPPFLAGS="$flags" "$@"
}

prepare() {
	cd $_linuxsrc
	_kernelmake clean && _kernelmake distclean && _kernelmake mrproper
	cp -f $srcdir/config $srcdir/$_linuxsrc/.config
	#_kernelmake localmodconfig # Quick test
	_kernelmake prepare
}

build() {
	cd $_linuxsrc
	_kernelmake all
}

package() {
	cd $srcdir/$_linuxsrc
	_kernelmake INSTALL_MOD_STRIP=1 INSTALL_MOD_PATH=$pkgdir/usr modules_install 
	rm -f $pkgdir/usr/lib/modules/$pkgver-$_arch/{build,source}
	install -Dm 644 $srcdir/$_linuxsrc/arch/x86_64/boot/bzImage $pkgdir/boot/vmlinuz-linux-$_arch

	# For headers
	#mkdir $pkgdir/usr/lib/modules/$pkgver-$_arch/build
	#_kernelmake INSTALL_HDR_PATH=$pkgdir/usr/lib/modules/$pkgver-$_arch/build headers_install 
	#mkdir $pkgdir/usr/src
	#ln -s $pkgdir/usr/lib/modules/$pkgver-$_arch/build $pkgdir/usr/src/linux-$_arch

	cp -f "${startdir}/${install}" "${startdir}/${install}.pkg"
	true && install=${install}.pkg
	sed -i "s/kernelarch=/kernelarch=$_arch/g" "${startdir}/${install}"

	install -Dm 644 $srcdir/linux.preset $pkgdir/etc/mkinitcpio.d/linux-$_arch.preset
	sed -i "s/linux/linux-$_arch/g" $pkgdir/etc/mkinitcpio.d/linux-$_arch.preset
}
