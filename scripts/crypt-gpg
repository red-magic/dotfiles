#!/bin/sh

set -e

progname=$(basename "$0")

print_help()
{
    printf "usage: %s -s | -a | -d file\n" "$progname"
}

if [ $# -gt 2 ]
then
    printf "%s: only 1 option and 1 argument are accepted\n" "$progname" >&2
    print_help
    exit 1
elif [ $# -eq 0 ]
then
    print_help
    exit 0
fi

mode=

case $1 in
    -s)
        mode=sym
        ;;
    -a)
        mode=asym
        ;;
    -d)
        mode=dec
        ;;
    *)
        printf "%s: invalid option: %s\n" "$progname" "$1" >&2
        print_help
        exit 1
        ;;
esac

file=$2

if [ -z "$file" ]
then
    printf "%s: %s: missing file argument\n" "$progname" "$1" >&2
    print_help
    exit 1
fi

case $mode in
    sym | asym)
        file_dec=$file
        file_enc=$file.gpg

        if [ ! -f "$file_dec" ]
        then
            printf "%s: %s: file %s doesn't exist\n" "$progname" "$1" "$file_dec" >&2
            exit 1
        fi

        if [ -f "$file_enc" ]
        then
            printf "%s: %s: file %s already exists\n" "$progname" "$1" "$file_enc" >&2
            exit 1
        fi
        ;;
    dec)
        case $file in
            *.gpg) ;;
            *)
                printf "%s: %s: not a .gpg file: %s\n" "$progname" "$1" "$file" >&2
                exit 1
                ;;
        esac

        file_enc=$file
        file_dec=${file%.gpg}

        if [ ! -f "$file_enc" ]
        then
            printf "%s: %s: file %s doesn't exist\n" "$progname" "$1" "$file_enc" >&2
            exit 1
        fi

        if [ -f "$file_dec" ]
        then
            printf "%s: %s: file %s already exists\n" "$progname" "$1" "$file_dec" >&2
            exit 1
        fi
        ;;
esac

case $mode in
    sym)
        gpg -o "$file_enc" \
            --s2k-cipher-algo AES256 \
            --s2k-digest-algo SHA512 \
            --force-aead \
            --no-compress \
            -c "$file_dec"
        ;;
    asym)
        gpg -o "$file_enc" \
            --cipher-algo AES256 \
            --digest-algo SHA512 \
            --force-aead \
            --no-compress \
            -es "$file_dec"
        ;;
    dec)
        gpg -do "$file_dec" "$file_enc"
        ;;
esac
